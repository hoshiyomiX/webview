name: üîß Refactor Package Structure (One-Time)

# Manual trigger only - run once then delete this file
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "REFACTOR" to confirm package rename'
        required: true
        default: ''

jobs:
  refactor-package:
    name: Rename com.example.app to com.deviant.batterymonitor
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚úÖ Validate Confirmation
        if: github.event.inputs.confirm != 'REFACTOR'
        run: |
          echo "Confirmation failed. Please type REFACTOR to proceed."
          exit 1
      
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          ref: battery-monitor
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: üîç Check Current Structure
        run: |
          echo "=== Current Java Package Structure ==="
          find app/src/main/java -type f -name "*.java"
          echo ""
          echo "=== Current Package Declarations ==="
          grep -r "^package " app/src/main/java/ || true
      
      - name: üèóÔ∏è Create New Package Structure
        run: |
          echo "Creating new directory structure..."
          mkdir -p app/src/main/java/com/deviant/batterymonitor
          
          echo "Directory created:"
          ls -la app/src/main/java/com/deviant/batterymonitor/
      
      - name: üöö Move Java Files
        run: |
          echo "Moving Java files from com.example.app to com.deviant.batterymonitor..."
          
          # Find and move all .java files
          if [ -d "app/src/main/java/com/example/app" ]; then
            find app/src/main/java/com/example/app -type f -name "*.java" -exec mv {} app/src/main/java/com/deviant/batterymonitor/ \;
            echo "Files moved successfully"
          else
            echo "Old package directory not found, might already be refactored"
          fi
          
          echo ""
          echo "Files in new location:"
          ls -la app/src/main/java/com/deviant/batterymonitor/
      
      - name: ‚úèÔ∏è Update Package Declarations
        run: |
          echo "Updating package declarations in Java files..."
          
          # Update package declarations
          find app/src/main/java/com/deviant/batterymonitor -type f -name "*.java" -exec sed -i 's/package com\.example\.app;/package com.deviant.batterymonitor;/g' {} \;
          
          # Update import statements (if any cross-references)
          find app/src/main/java/com/deviant/batterymonitor -type f -name "*.java" -exec sed -i 's/import com\.example\.app\./import com.deviant.batterymonitor./g' {} \;
          
          echo "Package declarations updated"
          echo ""
          echo "New package declarations:"
          grep -r "^package " app/src/main/java/com/deviant/batterymonitor/ || true
      
      - name: üóëÔ∏è Remove Old Package Directories
        run: |
          echo "Cleaning up old package structure..."
          
          if [ -d "app/src/main/java/com/example" ]; then
            rm -rf app/src/main/java/com/example
            echo "Removed com/example/"
          fi
          
          echo ""
          echo "Final structure:"
          tree app/src/main/java/ || find app/src/main/java -type f
      
      - name: üìä Show Changes
        run: |
          echo "=== Git Status ==="
          git status
          echo ""
          echo "=== Changes Summary ==="
          git diff --stat
          echo ""
          echo "=== Detailed Changes ==="
          git diff --color
      
      - name: üíæ Commit & Push Changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add app/src/main/java/
          
          if git diff --cached --quiet; then
            echo "No changes to commit (might already be refactored)"
          else
            git commit -m "refactor: Rename package com.example.app to com.deviant.batterymonitor
          
          - Move Java files to new package structure
          - Update package declarations
          - Update import statements
          - Remove old com.example.app directory
          
          Auto-generated by GitHub Actions workflow"
            
            git push origin battery-monitor
            echo "Changes pushed successfully!"
          fi
      
      - name: üéâ Success Summary
        run: |
          echo "================================================"
          echo "   PACKAGE REFACTORING COMPLETED!"
          echo "================================================"
          echo ""
          echo "Old Package: com.example.app"
          echo "New Package: com.deviant.batterymonitor"
          echo ""
          echo "New Structure:"
          echo "app/src/main/java/"
          echo "  com/"
          echo "    deviant/"
          echo "      batterymonitor/"
          echo "        MainActivity.java"
          echo ""
          echo "NEXT STEP: Delete this workflow file!"
          echo "File to delete: .github/workflows/refactor-package.yml"
          echo ""
          echo "Command:"
          echo "  git rm .github/workflows/refactor-package.yml"
          echo "  git commit -m 'chore: Remove one-time refactor workflow'"
          echo "  git push origin master"
