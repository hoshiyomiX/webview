name: ğŸ”§ Refactor Package Structure (One-Time)

# Manual trigger only - run once then delete this file
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "REFACTOR" to confirm package rename'
        required: true
        default: ''

jobs:
  refactor-package:
    name: Rename com.example.app â†’ com.deviant.batterymonitor
    runs-on: ubuntu-latest
    
    steps:
      - name: âœ… Validate Confirmation
        if: github.event.inputs.confirm != 'REFACTOR'
        run: |
          echo "âŒ Confirmation failed. Please type 'REFACTOR' to proceed."
          exit 1
      
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: battery-monitor
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ” Check Current Structure
        run: |
          echo "=== Current Java Package Structure ==="
          find app/src/main/java -type f -name "*.java"
          echo ""
          echo "=== Current Package Declarations ==="
          grep -r "^package " app/src/main/java/ || true
      
      - name: ğŸ—ï¸ Create New Package Structure
        run: |
          echo "Creating new directory structure..."
          mkdir -p app/src/main/java/com/deviant/batterymonitor
          
          echo "Directory created:"
          ls -la app/src/main/java/com/deviant/batterymonitor/
      
      - name: ğŸšš Move Java Files
        run: |
          echo "Moving Java files from com.example.app to com.deviant.batterymonitor..."
          
          # Find and move all .java files
          if [ -d "app/src/main/java/com/example/app" ]; then
            find app/src/main/java/com/example/app -type f -name "*.java" -exec mv {} app/src/main/java/com/deviant/batterymonitor/ \;
            echo "âœ… Files moved successfully"
          else
            echo "âš ï¸ Old package directory not found, might already be refactored"
          fi
          
          echo ""
          echo "Files in new location:"
          ls -la app/src/main/java/com/deviant/batterymonitor/
      
      - name: âœï¸ Update Package Declarations
        run: |
          echo "Updating package declarations in Java files..."
          
          # Update package declarations
          find app/src/main/java/com/deviant/batterymonitor -type f -name "*.java" -exec sed -i 's/package com\.example\.app;/package com.deviant.batterymonitor;/g' {} \;
          
          # Update import statements (if any cross-references)
          find app/src/main/java/com/deviant/batterymonitor -type f -name "*.java" -exec sed -i 's/import com\.example\.app\./import com.deviant.batterymonitor./g' {} \;
          
          echo "âœ… Package declarations updated"
          echo ""
          echo "New package declarations:"
          grep -r "^package " app/src/main/java/com/deviant/batterymonitor/ || true
      
      - name: ğŸ—‘ï¸ Remove Old Package Directories
        run: |
          echo "Cleaning up old package structure..."
          
          if [ -d "app/src/main/java/com/example" ]; then
            rm -rf app/src/main/java/com/example
            echo "âœ… Removed com/example/"
          fi
          
          echo ""
          echo "Final structure:"
          tree app/src/main/java/ || find app/src/main/java -type f
      
      - name: ğŸ“Š Show Changes
        run: |
          echo "=== Git Status ==="
          git status
          echo ""
          echo "=== Changes Summary ==="
          git diff --stat
          echo ""
          echo "=== Detailed Changes ==="
          git diff --color
      
      - name: ğŸ’¾ Commit & Push Changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add app/src/main/java/
          
          if git diff --cached --quiet; then
            echo "âš ï¸ No changes to commit (might already be refactored)"
          else
            git commit -m "refactor: Rename package com.example.app â†’ com.deviant.batterymonitor

- Move Java files to new package structure
- Update package declarations
- Update import statements
- Remove old com.example.app directory

Auto-generated by GitHub Actions workflow"
            
            git push origin battery-monitor
            echo "âœ… Changes pushed successfully!"
          fi
      
      - name: ğŸ‰ Success Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… PACKAGE REFACTORING COMPLETED!            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Old Package: com.example.app"
          echo "New Package: com.deviant.batterymonitor"
          echo ""
          echo "ğŸ“ New Structure:"
          echo "app/src/main/java/"
          echo "â””â”€â”€ com/"
          echo "    â””â”€â”€ deviant/"
          echo "        â””â”€â”€ batterymonitor/"
          echo "            â””â”€â”€ MainActivity.java"
          echo ""
          echo "ğŸ—‘ï¸ NEXT STEP: Delete this workflow file!"
          echo "File to delete: .github/workflows/refactor-package.yml"
          echo ""
          echo "Command:"
          echo "git rm .github/workflows/refactor-package.yml"
          echo "git commit -m 'chore: Remove one-time refactor workflow'"
          echo "git push origin battery-monitor"
